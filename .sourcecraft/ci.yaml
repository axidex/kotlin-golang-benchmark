on:
  push:
    - workflows:
        - build-workflow
      filter:
        branches:
          - "main"


workflows:
  build-workflow:
    settings:
      max_cube_duration: 20m
    checkout:
      enabled: true
    env:
      DOCKER_USER: ${{ secrets.docker.user }}
      DOCKER_TOKEN: ${{ secrets.docker.pat }}
    tasks:
      - name: build-go
        uses: build-go-task

      - name: build-kotlin
        uses: build-kotlin-task



  get-env:
    runs_on: [ "internal" ]
    settings:
      max_cube_duration: 10m
    checkout:
      enabled: true
    tasks:
      - get-env

tasks:
  - name: build-go-task
    cubes:
      - uses: docker-login

      - name: build-go-cube
        script:
          - cd golang-gin
          - docker build -t $DOCKER_USER/benchmark-golang-gin:latest .
          - docker push $DOCKER_USER/benchmark-golang-gin:latest

  - name: build-kotlin-task
    cubes:
      - uses: docker-login

      - name: build-kotlin-cube
        script:
          - cd kotlin-quarkus
          - docker build -t $DOCKER_USER/benchmark-kotlin-quarkus:latest .
          - docker push $DOCKER_USER/benchmark-kotlin-quarkus:latest


  - name: get-env
    cubes:
      - name: print-env
        script:
          - env

cubes:
  - name: docker-login
    script:
      - echo $DOCKER_TOKEN | docker login -u $DOCKER_USER --password-stdin
